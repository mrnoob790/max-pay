<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google + File Picker</title>
</head>
<body>
<button id="startBtn">Open Google & File Picker</button>

<script>
document.getElementById("startBtn").addEventListener("click", async () => {
    // 1. Google tab open करो
    window.open("https://www.google.com", "_blank");

    // 2. 1 second delay दो, लेकिन promise chain में user gesture maintain करो
    await new Promise(r => setTimeout(r, 1000));

    // 3. File picker open करो
    try {
        const [fileHandle] = await window.showOpenFilePicker({
            types: [{
                description: "Images",
                accept: {"image/*": [".png", ".jpg", ".jpeg", ".gif"]}
            }]
        });
        const file = await fileHandle.getFile();
        alert(`Selected file: ${file.name}`);
    } catch (e) {
        console.log("Picker canceled or blocked:", e);
    }
});
</script>
</body>
</html>

  // Save a small user intent when user clicks "Prepare".
  prepareBtn.addEventListener('click', (e) => {
    lastUserActivation = Date.now();
    status.textContent = 'Prepared. Switch tabs and come back within 5s to auto-open picker.';
    // Optionally give visual feedback that activation is consumed later,
    // but we keep timestamp so visibilitychange can use it.
  });

  // Also allow immediate open (regular user gesture).
  openNowBtn.addEventListener('click', async (e) => {
    status.textContent = 'Opening picker...';
    try {
      const [handle] = await window.showOpenFilePicker({
        types: [{ accept: { 'image/*': ['.png', '.jpg', '.jpeg', '.webp'] } }],
        multiple: false
      });
      const file = await handle.getFile();
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      status.textContent = `Selected: ${file.name}`;
    } catch (err) {
      status.textContent = `Picker cancelled / blocked: ${err.name}`;
      console.error(err);
    }
  });

  // When tab becomes visible, check if we have a recent user activation.
  document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState !== 'visible') return;

    const now = Date.now();
    if (lastUserActivation === 0) {
      // No prior intent.
      status.textContent = 'Visible — no prepared upload intent.';
      return;
    }

    if ((now - lastUserActivation) > ACTIVATION_EXPIRY_MS) {
      // Activation expired.
      status.textContent = 'Prepared intent expired. Click Prepare again to enable auto-open.';
      lastUserActivation = 0;
      return;
    }

    // We have a recent user activation — attempt to open picker.
    status.textContent = 'Auto-opening picker (based on your recent intent)...';
    try {
      const [handle] = await window.showOpenFilePicker({
        types: [{ accept: { 'image/*': ['.png', '.jpg', '.jpeg', '.webp'] } }],
        multiple: false
      });
      const file = await handle.getFile();
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      status.textContent = `Selected: ${file.name}`;
    } catch (err) {
      status.textContent = `Picker cancelled / blocked: ${err.name}`;
      console.error(err);
    } finally {
      // Clear the activation so it can't be reused.
      lastUserActivation = 0;
    }
  });

  // Optional: clear activation when user navigates away or interacts with other controls.
  window.addEventListener('pagehide', () => { lastUserActivation = 0; });
})();
</script>
</body>
</html>
